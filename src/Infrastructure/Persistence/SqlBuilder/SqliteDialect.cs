using System;
using System.Collections.Generic;
using System.Data;
using System.Diagnostics.CodeAnalysis;
using System.Text;

namespace csumathboy.Infrastructure.Persistence.SqlBuilder;

public class SqliteDialect : SqlDialectBase
  {
      public override string GetIdentitySql(string tableName)
      {
          return "SELECT LAST_INSERT_ROWID() AS [Id]";
      }

      public override string GetPagingSql(string sql, int page, int resultsPerPage, IDictionary<string, object> parameters, string partitionBy)
      {
          return GetSetSql(sql, GetStartValue(page, resultsPerPage), resultsPerPage, parameters);
      }

      public override string GetSetSql(string sql, int firstResult, int maxResults, IDictionary<string, object> parameters)
      {
          if (string.IsNullOrEmpty(sql))
              throw new ArgumentNullException(nameof(sql), $"{nameof(sql)} cannot be null.");

          if (parameters == null)
              throw new ArgumentNullException(nameof(parameters), $"{nameof(parameters)} cannot be null.");

          if (!IsSelectSql(sql))
              throw new ArgumentException($"{nameof(sql)} must be a SELECT statement.", nameof(sql));

          var result = string.Format("{0} LIMIT @Offset, @Count", sql);
          parameters.Add("@Offset", firstResult);
          parameters.Add("@Count", maxResults);
          return result;
      }

      public override string GetDatabaseFunctionString(DatabaseFunction databaseFunction, string columnName, string functionParameters = "")
      {
          return databaseFunction switch
          {
              DatabaseFunction.NullValue => $"IsNull({columnName}, {functionParameters})",
              DatabaseFunction.Truncate => $"Truncate({columnName})",
              _ => columnName,
          };
      }

      [ExcludeFromCodeCoverage]
      public override void EnableCaseInsensitive(IDbConnection connection)
      {
      }
  }
